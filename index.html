<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Bad Bitch Quests</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --bg:#0b0b0f; --card:#141827; --ink:#f7f8ff; --muted:#a6adbb; --accent:#ffd400; }
    body { margin:0; font-family:-apple-system,Inter,system-ui,Arial; background:var(--bg); color:var(--ink); }
    header { position:sticky; top:0; padding:14px 16px; background:#0b0b0fcc; backdrop-filter: blur(8px); border-bottom:1px solid #1f2538; }
    h1 { margin:0; font-size:18px; }
    main { max-width:720px; margin:0 auto; padding:16px; display:grid; gap:12px; }
    .card { background:var(--card); border:1px solid #242b3f; border-radius:14px; padding:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input { flex:1; min-width:140px; background:#0e1220; color:var(--ink); border:1px solid #2a3150; border-radius:12px; padding:10px; }
    button { background:linear-gradient(180deg,#ffe56b,#ffd400); color:#111; font-weight:800; border:0; border-radius:12px; padding:10px 12px; }
    .ghost { background:#0e1220; color:var(--ink); border:1px solid #2a3150; }
    .muted { color:var(--muted); font-size:12px; }
    .item { padding:10px; border:1px solid #252c42; border-radius:12px; background:#0e1220; display:grid; gap:4px; }
    .tag { font-size:12px; padding:2px 6px; border-radius:999px; background:#171b29; border:1px solid #2a3150; color:var(--muted); }
  </style>
</head>
<body>
<header><h1>ðŸ”¥ Bad Bitch Quests</h1></header>
<main>
  <section class="card">
    <div class="row">
      <input id="title" placeholder="Quest title (e.g., DoorDash 2h)"/>
      <input id="due" type="date"/>
    </div>
    <div class="row">
      <input id="user" placeholder="Your ID (e.g., kenny)"/>
      <button onclick="addQuest()">Add Quest</button>
      <button class="ghost" onclick="refresh()">Refresh</button>
      <button class="ghost" onclick="chaos()">Chaos Drop</button>
    </div>
    <div class="muted">Tip: set your ID once; Iâ€™ll use it for reminders & XP.</div>
  </section>

  <section id="stats" class="card"></section>
  <section id="list" class="card"></section>
</main>

<script>
const apiBase = location.origin;

document.getElementById('user').value = localStorage.getItem('bb_user') || 'kenny';
document.getElementById('user').addEventListener('change', e=>{
  localStorage.setItem('bb_user', e.target.value.trim());
});

async function addQuest(titleArg){
  const user = getUser();
  const title = titleArg || document.getElementById('title').value.trim();
  const due = document.getElementById('due').value || new Date().toISOString().slice(0,10);
  if(!title) return alert('Give the quest a title');

  const r = await fetch(`${apiBase}/api/quests?user=${encodeURIComponent(user)}`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ title, due })
  });
  const j = await r.json();
  if(!j.ok){ alert('Save failed'); return; }
  document.getElementById('title').value='';
  renderStats(j.stats);
  refresh();
}

async function refresh(){
  const user = getUser();
  const r = await fetch(`${apiBase}/api/quests?user=${encodeURIComponent(user)}`);
  const j = await r.json();
  renderStats(j.stats||{xp:0,streak:0});
  renderList(j.quests||[]);
}

async function toggleDone(id, done){
  const user = getUser();
  const r = await fetch(`${apiBase}/api/quests?user=${encodeURIComponent(user)}`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id, done })
  });
  const j = await r.json();
  if(!j.ok){ alert('Update failed'); return; }
  renderStats(j.stats);
  refresh();
}

async function snooze(id, which){
  const user = getUser();
  const r = await fetch(`${apiBase}/api/quests?user=${encodeURIComponent(user)}`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id, snooze: which })
  });
  const j = await r.json();
  if(!j.ok){ alert('Snooze failed'); return; }
  refresh();
}

async function chaos(){
  const user = getUser();
  await fetch(`${apiBase}/api/chaos-add?user=${encodeURIComponent(user)}`); // auto-add a random drop
  refresh();
}

function renderList(list){
  const box = document.getElementById('list');
  if(!list.length){ box.innerHTML='<div class="muted">No quests yet.</div>'; return; }
  box.innerHTML = list
    .sort((a,b)=> (a.done?1:0)-(b.done?1:0) || a.due.localeCompare(b.due))
    .map(q=>`<div class="item">
      <div><strong>${q.title}</strong></div>
      <div class="row">
        <span class="tag">${q.due}${q.done?' â€¢ done':''}</span>
        <button class="ghost" onclick="snooze('${q.id}','tonight')">Snooze tonight</button>
        <button class="ghost" onclick="snooze('${q.id}','tomorrow')">Snooze tomorrow</button>
        <button onclick="toggleDone('${q.id}', ${!q.done})">${q.done?'Mark Undone':'Mark Done'}</button>
      </div>
    </div>`).join('');
}

function renderStats(s){ document.getElementById('stats').innerHTML = `
  <div><strong>XP:</strong> ${s.xp||0} â€¢ <strong>Streak:</strong> ${s.streak||0}</div>
  <div class="muted">Complete any quest to gain XP (+10) and keep your daily streak alive.</div>
`; }

function getUser(){ return (document.getElementById('user').value.trim() || 'kenny'); }

refresh();
</script>
</body>
</html>